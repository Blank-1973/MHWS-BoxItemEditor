name: Create Release

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
      tags:
        - 'v*'

  push:
    tags:
      - 'v*'  # 当推送新标签时触发

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install GitHub CLI
        run: sudo apt-get install gh

      - name: Authenticate GitHub CLI
        run: gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"

      - name: Create a zip of the directory for EN-US
        run: zip -r BoxItemEditor_EN-US.zip reframework -x "reframework/fonts/*" "*ZH-Hans*"

      - name: Create a zip of the directory for ZH-Hans
        run: zip -r BoxItemEditor_ZH-Hans.zip reframework -x "*EN-US*"

      - name: Generate checksums
        run: |
          sha256sum BoxItemEditor_EN-US.zip > BoxItemEditor_EN-US.zip.sha256
          sha256sum BoxItemEditor_ZH-Hans.zip > BoxItemEditor_ZH-Hans.zip.sha256

      - name: Check if release exists and delete it
        run: |
          if gh release view ${{ github.ref_name }}; then
            gh release delete ${{ github.ref_name }} --yes
          fi

      - name: Prepare release notes
        id: generate_notes
        run: |
          echo "## Files" > release_notes.md
          echo "- \`BoxItemEditor_EN-US.zip\`: Default version" >> release_notes.md
          echo "- \`BBoxItemEditor_ZH-Hans.zip\`: Chinese version (with NotoSans SC font file)" >> release_notes.md
          echo "## Checksums" > release_notes.md
          echo "- \`BoxItemEditor_EN-US.zip\` SHA-256: $(cut -d ' ' -f1 BoxItemEditor_EN-US.zip.sha256)" >> release_notes.md
          echo "- \`BoxItemEditor_ZH-Hans.zip\` SHA-256: $(cut -d ' ' -f1 BoxItemEditor_ZH-Hans.zip.sha256)" >> release_notes.md

      - name: Create GitHub Release
        id: create_release
        run: |
          gh release create ${{ github.ref_name }} *.zip --title "${{ github.ref_name }} Release" --notes-file release_notes.md
